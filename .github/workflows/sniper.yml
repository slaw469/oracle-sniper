name: Oracle Instance Sniper

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  snipe:
    runs-on: ubuntu-latest
    env:
      COMPARTMENT_ID: "ocid1.tenancy.oc1..aaaaaaaarymrdubanaqs367n3nkdshevcmyhqlyvgbglgktnsi6r7f6ljvsa"
      SUBNET_ID: "ocid1.subnet.oc1.us-chicago-1.aaaaaaaayp7nnbefv5r6nwlh2wpsqhhnnzvsnm4bf6ikk7ccer7p5cts55da"
      IMAGE_ID: "ocid1.image.oc1.us-chicago-1.aaaaaaaabcnwiemw73knztoo4nbu7uhlzu24cwdgynddt4yxb2d5vag2rzcq"
      SHAPE: "VM.Standard.A1.Flex"
    steps:
      - name: Install OCI CLI
        run: pip install oci-cli

      - name: Configure OCI
        env:
          OCI_PRIVATE_KEY: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
        run: |
          mkdir -p ~/.oci
          printf '%s\n' "$OCI_PRIVATE_KEY" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=$OCI_USER_OCID
          fingerprint=$OCI_FINGERPRINT
          tenancy=$OCI_TENANCY_OCID
          region=$OCI_REGION
          key_file=$HOME/.oci/key.pem
          EOF
          chmod 600 ~/.oci/config

      - name: Check for existing instance
        id: check
        run: |
          EXISTING=$(oci compute instance list \
            --compartment-id "$COMPARTMENT_ID" \
            --display-name "claude-server" \
            --lifecycle-state RUNNING \
            --query 'data[0].id' \
            --raw-output 2>/dev/null || echo "")
          if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ] && [ "$EXISTING" != "None" ]; then
            echo "Instance already exists: $EXISTING"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "No existing instance found"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Snipe instance
        if: steps.check.outputs.exists == 'false'
        id: snipe
        env:
          SSH_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          # Cloud-init script to auto-setup the server on first boot
          CLOUD_INIT=$(cat << 'CLOUDINIT'
          #!/bin/bash
          set -e
          exec > /var/log/server-setup.log 2>&1
          echo "=== Server setup started at $(date) ==="

          # Update system
          apt-get update && apt-get upgrade -y

          # Install essentials
          apt-get install -y git curl wget build-essential

          # Install Node.js 20
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs

          # Install Claude Code
          npm install -g @anthropic-ai/claude-code

          # Install useful tools
          apt-get install -y tmux htop unzip jq

          # Set up firewall - allow SSH only
          ufw allow 22/tcp
          ufw --force enable

          # Create a welcome message
          cat > /etc/motd << 'MOTD'

          ========================================
            Oracle Free Tier ARM Server
            4 OCPUs | 24GB RAM | Ubuntu
            Claude Code is installed!
            Run: claude
          ========================================

          MOTD

          # Mark setup as complete
          touch /home/ubuntu/.setup-complete
          echo "=== Server setup completed at $(date) ==="
          CLOUDINIT
          )

          CLOUD_INIT_B64=$(echo "$CLOUD_INIT" | base64 -w 0)

          ADS=("OrUj:US-CHICAGO-1-AD-1" "OrUj:US-CHICAGO-1-AD-2" "OrUj:US-CHICAGO-1-AD-3")
          for AD in "${ADS[@]}"; do
            echo "Trying $AD..."
            RESULT=$(oci compute instance launch \
              --compartment-id "$COMPARTMENT_ID" \
              --availability-domain "$AD" \
              --shape "$SHAPE" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --image-id "$IMAGE_ID" \
              --subnet-id "$SUBNET_ID" \
              --display-name "claude-server" \
              --assign-public-ip true \
              --metadata "{\"ssh_authorized_keys\": \"$SSH_KEY\", \"user_data\": \"$CLOUD_INIT_B64\"}" \
              --query 'data.id' \
              --raw-output 2>&1) || true
            if [[ "$RESULT" == ocid1.instance.* ]]; then
              echo "SUCCESS! Instance ID: $RESULT"
              INSTANCE_ID="$RESULT"
              sleep 60
              for i in $(seq 1 10); do
                PUBLIC_IP=$(oci compute instance list-vnics \
                  --instance-id "$INSTANCE_ID" \
                  --query 'data[0]."public-ip"' \
                  --raw-output 2>/dev/null || echo "")
                if [ -n "$PUBLIC_IP" ] && [ "$PUBLIC_IP" != "null" ] && [ "$PUBLIC_IP" != "None" ]; then
                  echo "Public IP: $PUBLIC_IP"
                  echo "ip=$PUBLIC_IP" >> "$GITHUB_OUTPUT"
                  echo "success=true" >> "$GITHUB_OUTPUT"
                  exit 0
                fi
                echo "Waiting for IP (attempt $i/10)..."
                sleep 15
              done
              echo "Instance created but no IP yet"
              echo "success=true" >> "$GITHUB_OUTPUT"
              echo "ip=check-console" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            if echo "$RESULT" | grep -qi "Out of capacity\|out of host capacity"; then
              echo "No capacity in $AD"
            elif echo "$RESULT" | grep -qi "TooManyRequests\|429\|rate"; then
              echo "Rate limited, stopping"
              exit 0
            else
              echo "Error: $(echo "$RESULT" | head -3)"
            fi
          done

      - name: Notify on success
        if: steps.snipe.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const ip = '${{ steps.snipe.outputs.ip }}' || 'Check Oracle Console';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Oracle VM Created!',
              body: [
                '## Your server is ready!',
                '',
                '**Public IP:** `' + ip + '`',
                '',
                '### Connect from your Mac:',
                '```',
                'ssh -i ~/Downloads/ssh-key-2026-02-07.key ubuntu@' + ip,
                '```',
                '',
                '### Connect from your phone:',
                '1. Install **Termius** from the App Store',
                '2. Add host: `' + ip + '`',
                '3. Username: `ubuntu`',
                '4. Import your SSH private key',
                '',
                '### What was auto-installed:',
                '- Node.js 20',
                '- Claude Code (`claude`)',
                '- git, tmux, htop, jq',
                '- UFW firewall (SSH only)',
                '',
                'Cloud-init setup takes ~3-5 min after boot.',
                'Check progress: `cat /var/log/server-setup.log`',
                '',
                'Once setup is done, just run `claude` and authenticate!'
              ].join('\n')
            });
